<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Quản Lý Sự Kiện</title>
    <!-- Tailwind CSS Play CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="flex">
        <aside class="sidebar bg-gray-800 p-6 text-white w-64">
            <h2 class="text-2xl font-bold text-teal-600 mb-8 text-center">MyEV</h2>
            <ul class="space-y-5">
                <li><a href="Dashboard.html" class="flex items-center space-x-3 p-3 rounded-lg"><i class="fas fa-home text-teal-500"></i><span>Dashboard</span></a></li>
                <li><a href="Conference.html" class="flex items-center space-x-3 p-3 rounded-lg"><i class="fas fa-calendar-alt text-teal-500"></i><span>Sự Kiện / Hội Thảo</span></a></li>
                <li><a href="Organization.html" class="flex items-center space-x-3 p-3 rounded-lg"><i class="fas fa-building text-teal-500"></i><span>Tổ Chức</span></a></li>
                <li><a href="Registration.html" class="flex items-center space-x-3 p-3 rounded-lg"><i class="fas fa-users text-teal-500"></i><span>Tham Dự</span></a></li>
                <li><a href="User.html" class="flex items-center space-x-3 p-3 rounded-lg"><i class="fas fa-user text-teal-500"></i><span>Người Dùng</span></a></li>
                <li><a href="Contracts.html" class="flex items-center space-x-3 p-3 rounded-lg"><i class="fas fa-file-contract text-teal-500"></i><span>Hợp Đồng</span></a></li>
                <li><a href="Notifications.html" class="flex items-center space-x-3 p-3 rounded-lg"><i class="fas fa-bell text-teal-500"></i><span>Thông Báo</span></a></li>
                <li>
                    <button onclick="handleLogout()" class="flex items-center space-x-3 text-red-500 hover:bg-red-100 p-3 rounded-lg">
                        <i class="fas fa-sign-out-alt text-red-500"></i><span>Đăng Xuất</span>
                    </button>
                </li>
            </ul>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content flex-1 p-8 bg-white">
            <header class="flex items-center justify-between p-6 bg-white shadow-md rounded-lg mb-8">
                <!-- Tìm kiếm -->
                <div class="relative w-1/3">
                    <input type="text" placeholder="Tìm kiếm..." class="w-full p-3 pl-12 rounded-lg bg-gray-200 text-gray-700 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-teal-500 transition duration-300">
                    <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
                </div>
                <div class="flex items-center space-x-6">
                    <div class="relative">
                        <i class="fas fa-bell text-gray-600 hover:text-teal-500 transition-colors duration-200"></i>
                        <span class="absolute top-0 right-0 text-xs bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center">3</span>
                    </div>
                    <i class="fas fa-envelope text-gray-600 hover:text-teal-500 transition-colors duration-200"></i>
                    <div class="bg-gray-200 p-3 rounded-full text-gray-700 font-semibold">Admin</div>
                </div>
            </header>

            <section id="dashboardContent" class="section-content">
                <h2 class="text-3xl font-bold mb-6">Dashboard</h2>
                
                <!-- Metric Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-300">
                        <h3 class="text-lg text-teal-600 font-bold mb-2">Tổng Doanh Thu Từ Sự Kiện</h3>
                        <p class="text-4xl font-bold text-gray-800">$000</p>
                        <p class="mt-2 text-sm text-green-500">+10% so với tháng trước</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-300">
                        <h3 class="text-lg text-teal-600 font-bold mb-2">Tổng Đăng Ký Sự Kiện/Hội Thảo</h3>
                        <p class="text-4xl font-bold text-gray-800">92</p>
                        <p class="mt-2 text-sm text-green-500">+7% so với tháng trước</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-300">
                        <h3 class="text-lg text-teal-600 font-bold mb-2">Người Dùng Hoạt Động</h3>
                        <p class="text-4xl font-bold text-gray-800">422</p>
                        <p class="mt-2 text-sm text-green-500">+3.8% tăng trưởng</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-300">
                        <h3 class="text-lg text-teal-600 font-bold mb-2">Sự Kiện Tháng Này</h3>
                        <p class="text-4xl font-bold text-gray-800">43</p>
                        <p class="mt-2 text-sm text-red-500">-1 sự kiện so với tuần trước</p>
                    </div>
                </div>
            
                <!-- Chart and Calendar Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-10">
                    <!-- Sales Revenue Chart -->
                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-300 transition-transform duration-200 hover:shadow-lg hover:scale-102">
                        <div class="flex items-center justify-between mb-4 border-b border-gray-300 pb-2">
                            <h3 class="text-xl font-semibold text-teal-600">Doanh Thu Từ Sự Kiện (Theo Năm)</h3>
                            <span class="text-gray-500 text-sm">Tháng 1 - Tháng 6</span>
                        </div>
                        <p class="text-4xl font-extrabold text-gray-800 my-3">$000,000</p>
                        <p class="text-sm text-green-500 mb-4">+12% so với tháng trước</p>
                        <div class="relative h-64 mt-4">
                            <canvas id="salesRevenueChart"></canvas>
                        </div>
                    </div>
            
                    <!-- Calendar Section -->
                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-300 transition-transform duration-200 hover:shadow-lg hover:scale-102">
                        <div class="flex items-center justify-between mb-4 border-b border-gray-300 pb-2">
                            <h3 class="text-xl font-semibold text-teal-600">Lịch Tổ Chức</h3>
                            <span class="text-sm text-gray-500">Tháng 12, 2024</span>
                        </div>
                        <div id="dashboardCalendar" class="p-4 bg-gray-100 rounded-lg overflow-y-auto h-96 custom-scrollbar"></div>
                    </div>
                </div>
            
                <!-- Upcoming Events Section -->
                <section class="bg-white p-6 rounded-lg shadow-md border border-gray-300 mb-10">
                    <h3 class="text-lg text-teal-600 font-bold mb-4">Sắp Diễn Ra</h3>
                    <ul id="upcoming-events-list" class="divide-y divide-gray-200">
                      <!-- Upcoming events will be dynamically loaded here -->
                    </ul>
                  </section>
            </section>
        </main>
    </div>

    <!-- FullCalendar JS -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            // Kiểm tra tính hợp lệ của JWT
            await checkJwtValidity();

            // Khởi tạo FullCalendar
            initFullCalendar();

            // Tải sự kiện sắp diễn ra
            await loadUpcomingEvents();

            // Khởi tạo biểu đồ doanh thu
            initSalesRevenueChart();
        });

        // Hàm kiểm tra tính hợp lệ của JWT
        async function checkJwtValidity() {
            const token = localStorage.getItem('jwtToken');
            if (!token) {
                alert('Vui lòng đăng nhập!');
                window.location.href = '../login/login.html';
                return;
            }

            try {
                const response = await fetch('https://localhost:7111/api/Auth/validate-token', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (!response.ok || !data.isValid) {
                    alert(data.message || 'Phiên đăng nhập không hợp lệ. Vui lòng đăng nhập lại!');
                    localStorage.removeItem('jwtToken');
                    window.location.href = '../login/login.html';
                }
            } catch (error) {
                console.error('Lỗi khi kiểm tra JWT:', error);
                alert('Phiên đăng nhập không hợp lệ. Vui lòng đăng nhập lại!');
                localStorage.removeItem('jwtToken');
                window.location.href = '../login/login.html';
            }
        }

        // Hàm đăng xuất
        function handleLogout() {
            localStorage.removeItem('jwtToken'); // Xóa token
            alert('Đăng xuất thành công!');
            window.location.href = '../login/login.html'; // Chuyển hướng về trang đăng nhập
        }

        // Khởi tạo FullCalendar
        function initFullCalendar() {
            const calendarEl = document.getElementById('dashboardCalendar');
            window.calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                events: [
                    { title: 'Hội Thảo "Định Hướng Nghề Nghiệp"', start: '2024-11-25', color: '#8a2be2' },
                    { title: 'Code Review Sessions', start: '2024-11-15', color: '#f5a623' },
                    { title: 'Workshop "Kỹ Năng Giao Tiếp và Làm Việc Nhóm"', start: '2024-10-29', color: '#2ecc71' },
                    { title: 'Hội Thảo Công Nghệ', start: '2024-12-05', color: '#1abc9c' },
                ],
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                height: 500,
                dayMaxEventRows: true
            });
            window.calendar.render(); 
        }

        // Tải các sự kiện sắp diễn ra
        async function loadUpcomingEvents() {
            const conferenceAPI = 'https://localhost:7111/api/Conference';
            const token = localStorage.getItem('jwtToken'); // Lấy token từ lưu trữ cục bộ
            try {
                const response = await fetch(conferenceAPI, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (!response.ok) {
                    throw new Error('Failed to fetch data from API');
                }
                const conferences = await response.json();
                const today = new Date();
                const tenDaysLater = new Date(today);
                tenDaysLater.setDate(today.getDate() + 10);

                // Filter events happening in the next 10 days
                const upcomingEvents = conferences.filter(conf => {
                    const eventDate = new Date(conf.startDate);
                    return eventDate >= today && eventDate <= tenDaysLater;
                });

                // Update the HTML section with upcoming events
                const eventsList = document.querySelector('#upcoming-events-list');
                eventsList.innerHTML = '';
                upcomingEvents.forEach(event => {
                    const eventItem = document.createElement('li');
                    eventItem.className = 'py-4 flex items-center justify-between transition duration-200 hover:bg-gray-100 hover:rounded-lg p-4';
                    eventItem.innerHTML = `
                        <div class="flex items-center space-x-4">
                            <div class="bg-teal-500 p-3 rounded-full">
                                <i class="fas fa-calendar-alt text-white text-lg"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-xl text-gray-800">${event.conferenceName}</h4>
                                <p class="text-sm text-gray-500">Địa điểm: ${event.location}</p>
                            </div>
                        </div>
                        <span class="text-lg text-gray-500">${new Date(event.startDate).toLocaleDateString('vi-VN', {
                        day: 'numeric', month: 'long', year: 'numeric'
                    })}</span>
                    `;
                    eventsList.appendChild(eventItem);
                });
            } catch (error) {
                console.error('Error loading upcoming events:', error);
            }
        }

        // Khởi tạo biểu đồ Doanh Thu
        function initSalesRevenueChart() {
            const salesRevenueCtx = document.getElementById('salesRevenueChart').getContext('2d');
            new Chart(salesRevenueCtx, {
                type: 'line',
                data: {
                    labels: ['Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 'Tháng 6'],
                    datasets: [{
                        label: 'Doanh Thu',
                        data: [1000, 1200, 900, 1400, 1300, 1600],
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.2)',
                        borderWidth: 2,
                        pointRadius: 3,
                        fill: true,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: true,
                            backgroundColor: '#2d3748',
                            titleFont: { family: 'Arial', size: 14, weight: 'bold' },
                            bodyFont: { family: 'Arial', size: 12 },
                            callbacks: {
                                label: function(context) { return ` Doanh thu: $${context.raw}`; }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#d1d5db' },
                            grid: { display: false }
                        },
                        y: {
                            ticks: { color: '#d1d5db', callback: (value) => `$${value}` },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

    </script>
</body>
</html>
